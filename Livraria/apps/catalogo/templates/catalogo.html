{% extends 'base.html' %}

{% block title %}Catálogo{% endblock %}

{% block content %}
    <section class="bg-gradient-to-r from-cyan-50 to-white rounded-lg p-6 mb-8 shadow-sm">
        <div class="flex flex-col xl:flex-row items-center gap-4">
            <div class="flex-1">
                <h2 class="text-2xl font-semibold">Encontre seu próximo livro</h2>
                <p class="text-sm text-slate-500">Mais de 10.000 títulos. Frete para todo o Brasil.</p>
            </div>

            <form method="get" action="" class="flex w-full md:w-auto gap-2 flex-col xl:flex-row ">
                <input id="titulo" type="text" name="titulo" value="{{titulo}}" placeholder="Filtrar por titulo" class="flex-1 md:w-80 rounded-md border border-slate-200 px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-cyan-300">
                <input id="autor" type="text" name="autor" value="{{autor}}" placeholder="Filtrar por autor" class="flex-1 md:w-80 rounded-md border border-slate-200 px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-cyan-300">
                <input id="categoria" type="text" name="categoria" value="{{categoria}}" placeholder="Filtrar por categoria" class="flex-1 md:w-80 rounded-md border border-slate-200 px-3 py-2 shadow-sm focus:outline-none focus:ring-2 focus:ring-cyan-300">
                <button type="submit" class="px-4 py-2 rounded-md bg-gradient-to-br from-cyan-500 to-blue-600  text-white font-medium hover:bg-cyan-700 transition"> Filtrar</button>
            </form>
        </div>

    </section>


    <section class="">
        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4">
            {% for livro in livros %}
                <article class="bg-white p-3 rounded-lg shadow hover:shadow-lg transition">
                    <div class="aspect-[3/4] bg-slate-100 rounded overflow-hidden mb-3">
                        <a href="{% url 'detalhes_livro' livro.id %}">
                            <img src="{{ livro.volumeInfo.imageLinks.thumbnail }}"
                                alt="{{ livro.volumeInfo.title }}"
                                class="w-full h-full object-cover">
                        </a>
                    </div>

                    <h3 class="text-sm font-semibold"><a href="{% url 'detalhes_livro' livro.id %}">{{livro.volumeInfo.title |truncatechars:40 }}</a></h3>
                    <p class="text-xs text-slate-500">Autor: {{ livro.volumeInfo.authors|join:", "|default:"Sem Autor" }} • Categoria: Categorias: {{ livro.volumeInfo.categories|join:", "|default:"Sem categoria"  }}</p>
                    <div class="mt-3 flex items-center justify-between">
                        <span class="font-semibold">R$ {{ livro.saleInfo.retailPrice.amount|default:0.00|floatformat:2 }}</span>
                        <button class="btn-add-carrinho text-xs px-2 py-1 rounded border hover:bg-slate-50" data-id="{{livro.id}}">Adicionar</button>
                    </div>
                    <!-- <div class="flex items-center gap-4 text-xs">
                        <a class="hover:underline" href="{% url 'detalhes_livro' livro.id %}">Mais informações</a>
                    </div> -->
                </article>
            {% empty %}
                <p>Nenhum livro encontrado.</p>
            {% endfor %}

        </div>

    </section>
    <!-- <ul>
        {% for livro in livros %}
            <li>
                <img src="{{ livro.volumeInfo.imageLinks.thumbnail }}" alt="{{ livro.volumeInfo.title }}">
                <h2>{{ livro.volumeInfo.title }}</h2>
                <p>Autor(es):{{ livro.volumeInfo.authors|join:", "|default:"Sem Autor" }} Categorias: {{ livro.volumeInfo.categories|join:", "|default:"Sem categoria"  }}</p>
                <p>Publicado em: {{ livro.volumeInfo.publishedDate}}</p>
                <p>Preço: R$ {{ livro.saleInfo.retailPrice.amount|default:0.00|floatformat:2 }}</p>

                <a href="{% url 'detalhes_livro' livro.id %}">Mais informações</a>
                <button class="btn-add-carrinho" data-id="{{livro.id}}">Comprar</button>
            </li>
        {% empty %}
            <p>Nenhum livro encontrado.</p>
        {% endfor %}
    </ul> -->

    <div class="flex flex-row mt-4 justify-between gap-4">
        {% if titulo or autor or categoria %}
            {% if pag_obj.tem_anterior %}
                <a class="hover:underline mt-5"  href = "?{{ request.GET.urlencode }}&pagina={{ pag_obj.anterior }}">Voltar Página</a>
            {% endif %}
        {% else %}
            {% if pag_obj.tem_anterior %}
                <a class="hover:underline mt-5"  href = "?pagina={{ pag_obj.anterior }}">Voltar Página</a>
            {% endif %}
        {% endif %}
    
        <!-- Página: {{ pag_obj.number }} de {{pag_obj.paginator.num_pages}} -->
    
        {% if titulo or autor or categoria %}
            {% if pag_obj.tem_proxima %}
                <a class="hover:underline mt-5"  href = "?{{ request.GET.urlencode }}&pagina={{pag_obj.proxima }}">Pŕoxima Página</a>
            {% endif %}
        {% else %}
            {% if pag_obj.tem_proxima %}
                <a class="hover:underline mt-5"  href = "?pagina={{pag_obj.proxima }}">Pŕoxima Página</a>
            {% endif %}
        {% endif %}
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const botoesAdicionar = document.querySelectorAll('.btn-add-carrinho');

            botoesAdicionar.forEach(button => {
                button.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');

                    $.ajax({
                        url: "{% url 'add_carrinho' %}",
                        type: "POST",
                        data: {
                            'item_id': id,
                            'csrfmiddlewaretoken': '{{ csrf_token }}',
                        },
                        success: function(response) {
                            window.location.reload()
                        },
                        error: function(response) {
                            window.location.reload()
                        }
                    });
                    
                });
            });
        });
    </script>


{% endblock %}
